"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_get=function(e,t,n){for(var r=!0;r;){var o=e,a=t,i=n;r=!1,null===o&&(o=Function.prototype);var s=Object.getOwnPropertyDescriptor(o,a);if(void 0!==s){if("value"in s)return s.value;var l=s.get;if(void 0===l)return;return l.call(i)}var c=Object.getPrototypeOf(o);if(null===c)return;e=c,t=a,n=i,r=!0,s=c=void 0}},factory=function(e){var t=function(t){function n(e){var t=e.host,r=e.transaction_signer;_classCallCheck(this,n),_get(Object.getPrototypeOf(n.prototype),"constructor",this).call(this,t),this.transaction_signer=r,this.global_nonces={}}return _inherits(n,t),_createClass(n,[{key:"send",value:function(e){var t=e;t instanceof Array||(t=[t]);var r=!0,o=!1,a=void 0;try{for(var i,s=t[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var l=i.value;if("eth_sendTransaction"==l.method||"shh_post"==l.method)throw new Error("HookedWeb3Provider does not support synchronous transactions. Please provide a callback.")}}catch(c){o=!0,a=c}finally{try{!r&&s["return"]&&s["return"]()}finally{if(o)throw a}}return _get(Object.getPrototypeOf(n.prototype),"send",this).call(this,e)}},{key:"sendAsync",value:function(e,t){var r=this,o=Object.assign({},this.global_nonces),a=function(a){return a?(r.global_nonces=o,t(a,null)):void _get(Object.getPrototypeOf(n.prototype),"sendAsync",r).call(r,e,function(e,n){return(e||n.error)&&(this.global_nonces=o),t(e,n)}.bind(r))},i=e;e instanceof Array||(i=[e]),this.rewritePayloads(0,i,{},a)}},{key:"rewritePayloads",value:function(t,n,r,o){var a=this;if(t>=n.length)return o();var i=n[t],s=function(e){return null!=e?o(e):a.rewritePayloads(t+1,n,r,o)};if("eth_sendTransaction"!=i.method&&"shh_post"!=i.method)return s();var l=i.params[0],c=l.from;"shh_post"===i.method&&delete l.from,this.transaction_signer.hasAddress(c,function(t,n){if(null!=t||0==n)return s(t);var u=function(t){var n=r[c];null!=n?t(null,n):a.sendAsync({jsonrpc:"2.0",method:"eth_getTransactionCount",params:[c,"pending"],id:(new Date).getTime()},function(n,r){if(null!=n)t(n);else{var o=r.result;t(null,e.toDecimal(o))}})};"shh_post"===i.method?a.transaction_signer.signMessage(l,c,function(e,t){return null!=e?s(e):(i.params=[t],s())}):u(function(t,n){if(null!=t)return o(t);var u=Math.max(n,a.global_nonces[c]||0);l.nonce=e.toHex(u),r[c]=u+1,a.global_nonces[c]=u+1,a.transaction_signer.signTransaction(l,function(e,t){return null!=e?s(e):(i.method="eth_sendRawTransaction",i.params=[t],s())})})})}}]),n}(e.providers.HttpProvider);return t};if("undefined"!=typeof module){var Web3=require("web3"),_web3=new Web3;module.exports=factory(_web3)}else window.HookedWeb3Provider=factory(web3);